{"version":3,"file":"bulkactions.min.js","sources":["../../src/coupons/bulkactions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport $ from 'jquery';\nimport * as Notification from 'core/notification';\nimport * as Str from 'core/str';\nimport {add as addToast} from 'core/toast';\nimport {Service} from 'block_coupon/coupons/service';\nimport ModalForm from 'core_form/modalform';\n\nconst SELECTORS = {\n    checkbox: '[data-action=\"bulk\"]',\n    checkboxselectall: '[data-action=\"bulkcheckall\"]',\n    bulkactionselect: '[data-type=\"bulkaction\"]',\n    bulkcounter: '#bulk-counter',\n    bulkactions: {\n        container: '[data-region=\"bulkactions\"]',\n        \"delete\": '[data-action=\"bulkdelete\"]',\n        editcourses: '[data-action=\"editcourses\"]',\n        editcohorts: '[data-action=\"editcohorts\"]',\n    },\n    massactions: {\n        container: '[data-region=\"massactions\"]',\n        replacecohorts: '[data-action=\"replacecohorts\"]',\n        replacecourses: '[data-action=\"replacecourses\"]',\n    },\n    actions: {\n        editcoupon: '[data-action=\"editcoupon\"]',\n    }\n};\n\nconst enableBulkActions = (enable) => {\n    if (enable) {\n        document.querySelector(SELECTORS.bulkactionselect).removeAttribute('disabled');\n    } else {\n        document.querySelector(SELECTORS.bulkactionselect).setAttribute('disabled', 'disabled');\n    }\n};\n\nconst handleCheckboxChange = () => {\n    // Initialize dropdown state.\n    let size = $(`${SELECTORS.checkbox}:checked`).length;\n    $(SELECTORS.bulkcounter).html(`${size}`);\n    enableBulkActions(size > 0);\n    if (size > 0) {\n        // Enable/disable cohort/course types.\n        let types = getSelectedTypes();\n        document.querySelector(`${SELECTORS.bulkactions.container} ${SELECTORS.bulkactions.editcourses}`)\n                .classList.remove('hidden');\n        document.querySelector(`${SELECTORS.bulkactions.container} ${SELECTORS.bulkactions.editcohorts}`)\n                .classList.add('hidden');\n\n        if (types.length > 1) {\n            // Multiple types: disable all.\n            document.querySelector(`${SELECTORS.bulkactions.container} ${SELECTORS.bulkactions.editcourses}`)\n                    .classList.add('hidden');\n            document.querySelector(`${SELECTORS.bulkactions.container} ${SELECTORS.bulkactions.editcohorts}`)\n                    .classList.add('hidden');\n        } else {\n            let typ = types[0];\n            if (typ === 'cohort') {\n                // Enable cohort type.\n                document.querySelector(`${SELECTORS.bulkactions.container} ${SELECTORS.bulkactions.editcohorts}`)\n                        .classList.remove('hidden');\n            }\n            if (typ === 'course') {\n                // Enable course type.\n                document.querySelector(`${SELECTORS.bulkactions.container} ${SELECTORS.bulkactions.editcourses}`)\n                        .classList.remove('hidden');\n            }\n        }\n    }\n};\n\nconst getSelectedIds = () => {\n    let boxes = $(`${SELECTORS.checkbox}:checked`);\n    let ids = [];\n    boxes.each((idx, el) => {\n        ids.push(el.dataset.id);\n    });\n    return ids;\n};\n\nconst getSelectedTypes = () => {\n    let boxes = $(`${SELECTORS.checkbox}:checked`);\n    let typs = [];\n    boxes.each((idx, el) => {\n        typs.push(el.dataset.typ);\n    });\n    return Array.from(new Set(typs));\n};\n\nconst checkTypes = async() => {\n    let rs = getSelectedTypes();\n    if (rs.length > 1) {\n        let args = await Str.get_strings([\n            {key: 'err:bulkaction:typ:diff:title', component: 'block_coupon'},\n            {key: 'err:bulkaction:typ:diff:msg', component: 'block_coupon'},\n            {key: 'ok'},\n        ]);\n        Notification.alert(...args);\n        return false;\n    } else {\n        return true;\n    }\n};\n\nconst bulkDelete = async(e) => {\n    let rs = await checkTypes();\n    if (rs) {\n        // Display confirmation box.\n        e.preventDefault();\n        Str.get_strings([\n            {key: 'confirm', component: 'moodle'},\n            {key: 'deletecouponsconfirm', component: 'block_coupon'},\n            {key: 'deletecoupons', component: 'block_coupon'},\n            {key: 'cancel', component: 'moodle'}\n        ]).done(function(s) {\n            Notification.confirm(s[0], s[1], s[2], s[3], async () => {\n                let ids = getSelectedIds();\n                let rs = await Service.deleteCoupons(ids);\n                if (rs.result) {\n                    addToast(rs.msg, {type: 'success'});\n                    // Sleep 3/4 sec before reloading page.\n                    setTimeout(() => {window.location.reload();}, 750);\n                } else {\n                    addToast(rs.msg, {type: 'error'});\n                }\n            });\n        }).fail(Notification.exception);\n    }\n};\n\nconst bulkEditCourses = async(e) => {\n    let rs = await checkTypes();\n    if (rs) {\n        // Display dynamic form.\n        e.preventDefault();\n\n        let mfArgs = {};\n        if (e.currentTarget.dataset.jArgs !== undefined) {\n            let jArgs = e.currentTarget.dataset.jArgs;\n            if (typeof jArgs === 'string') {\n                jArgs = JSON.parse(jArgs);\n            }\n            for (const [key, value] of Object.entries(jArgs)) {\n                mfArgs[key] = value;\n            }\n        }\n\n        mfArgs.id = getSelectedIds();\n\n        const modalForm = new ModalForm({\n            formClass: 'block_coupon\\\\forms\\\\dynamic\\\\editcourses',\n            modalConfig: {title: Str.get_string('editcourses', 'block_coupon')},\n            args: mfArgs,\n            returnFocus: e.target\n        });\n\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => window.location.reload());\n        modalForm.show();\n    }\n};\n\nconst bulkEditCohorts = async(e) => {\n    let rs = await checkTypes();\n    if (rs) {\n        // Display dynamic form.\n        e.preventDefault();\n\n        let mfArgs = {};\n        if (e.currentTarget.dataset.jArgs !== undefined) {\n            let jArgs = e.currentTarget.dataset.jArgs;\n            if (typeof jArgs === 'string') {\n                jArgs = JSON.parse(jArgs);\n            }\n            for (const [key, value] of Object.entries(jArgs)) {\n                mfArgs[key] = value;\n            }\n        }\n\n        mfArgs.id = getSelectedIds();\n\n        const modalForm = new ModalForm({\n            formClass: 'block_coupon\\\\forms\\\\dynamic\\\\editcohorts',\n            modalConfig: {title: Str.get_string('editcohorts', 'block_coupon')},\n            args: mfArgs,\n            returnFocus: e.target\n        });\n\n        // When table ID not provided, detect.\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => window.location.reload());\n        modalForm.show();\n    }\n};\n\nconst bulkSelectAll = (e) => {\n    let state = e.currentTarget.checked;\n    let els = document.querySelectorAll(SELECTORS.checkbox);\n    [...els].forEach( (cb) => {cb.checked = state;});\n    handleCheckboxChange();\n};\n\nconst bulkReplaceCohorts = async(e) => {\n    e.preventDefault();\n\n    let mfArgs = {};\n    if (e.currentTarget.dataset.jArgs !== undefined) {\n        let jArgs = e.currentTarget.dataset.jArgs;\n        if (typeof jArgs === 'string') {\n            jArgs = JSON.parse(jArgs);\n        }\n        for (const [key, value] of Object.entries(jArgs)) {\n            mfArgs[key] = value;\n        }\n    }\n\n    const modalForm = new ModalForm({\n        formClass: 'block_coupon\\\\forms\\\\dynamic\\\\replacecohorts',\n        modalConfig: {title: Str.get_string('replacecohorts', 'block_coupon')},\n        args: mfArgs,\n        returnFocus: e.target\n    });\n\n    // When table ID not provided, detect.\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => window.location.reload());\n    modalForm.show();\n};\n\nconst bulkReplaceCourses = async(e) => {\n    e.preventDefault();\n\n    let mfArgs = {};\n    if (e.currentTarget.dataset.jArgs !== undefined) {\n        let jArgs = e.currentTarget.dataset.jArgs;\n        if (typeof jArgs === 'string') {\n            jArgs = JSON.parse(jArgs);\n        }\n        for (const [key, value] of Object.entries(jArgs)) {\n            mfArgs[key] = value;\n        }\n    }\n\n    const modalForm = new ModalForm({\n        formClass: 'block_coupon\\\\forms\\\\dynamic\\\\replacecourses',\n        modalConfig: {title: Str.get_string('replacecourses', 'block_coupon')},\n        args: mfArgs,\n        returnFocus: e.target\n    });\n\n    // When table ID not provided, detect.\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => window.location.reload());\n    modalForm.show();\n};\n\nconst editCoupon = (e) => {\n    e.preventDefault();\n\n    let mfArgs = {\n        id: e.currentTarget.dataset.id,\n        typ: e.currentTarget.dataset.typ,\n    };\n    let formClass = '';\n    switch (e.currentTarget.dataset.typ) {\n        case 'course':\n            formClass = 'block_coupon\\\\forms\\\\dynamic\\\\editcoursecoupon';\n            break;\n        case 'cohort':\n            formClass = 'block_coupon\\\\forms\\\\dynamic\\\\editcohortcoupon';\n            break;\n    }\n    if (e.currentTarget.dataset.jArgs !== undefined) {\n        let jArgs = e.currentTarget.dataset.jArgs;\n        if (typeof jArgs === 'string') {\n            jArgs = JSON.parse(jArgs);\n        }\n        for (const [key, value] of Object.entries(jArgs)) {\n            mfArgs[key] = value;\n        }\n    }\n\n    const modalForm = new ModalForm({\n        formClass,\n        modalConfig: {title: Str.get_string('edit')},\n        args: mfArgs,\n        returnFocus: e.target\n    });\n\n    // When table ID not provided, detect.\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => window.location.reload());\n    modalForm.show();\n};\n\nconst initBulkActions = (selector) => {\n    $(SELECTORS.checkboxselectall).on('change', bulkSelectAll);\n    // Initialize dropdown state.\n    enableBulkActions($(`${SELECTORS.checkbox}:checked`).length > 0);\n    // Initialize checkbox state changes.\n    $(SELECTORS.checkbox).on('change', handleCheckboxChange);\n    // Initialize bulk actions.\n    $(SELECTORS.bulkactions.container).on('click', SELECTORS.bulkactions.delete, bulkDelete);\n    $(SELECTORS.bulkactions.container).on('click', SELECTORS.bulkactions.editcourses, bulkEditCourses);\n    $(SELECTORS.bulkactions.container).on('click', SELECTORS.bulkactions.editcohorts, bulkEditCohorts);\n    $(SELECTORS.massactions.container).on('click', SELECTORS.massactions.replacecourses, bulkReplaceCourses);\n    $(SELECTORS.massactions.container).on('click', SELECTORS.massactions.replacecohorts, bulkReplaceCohorts);\n\n    $(selector).on('click', SELECTORS.actions.editcoupon, editCoupon);\n};\n\nexport const init = (selector) => {\n    initBulkActions(selector);\n};\n"],"names":["SELECTORS","container","editcourses","editcohorts","replacecohorts","replacecourses","editcoupon","enableBulkActions","enable","document","querySelector","removeAttribute","setAttribute","handleCheckboxChange","size","length","html","types","getSelectedTypes","classList","remove","add","typ","getSelectedIds","boxes","ids","each","idx","el","push","dataset","id","typs","Array","from","Set","checkTypes","async","args","Str","get_strings","key","component","Notification","alert","bulkDelete","e","preventDefault","done","s","confirm","rs","Service","deleteCoupons","result","msg","type","setTimeout","window","location","reload","fail","exception","bulkEditCourses","mfArgs","undefined","currentTarget","jArgs","JSON","parse","value","Object","entries","modalForm","ModalForm","formClass","modalConfig","title","get_string","returnFocus","target","addEventListener","events","FORM_SUBMITTED","show","bulkEditCohorts","bulkSelectAll","state","checked","querySelectorAll","forEach","cb","bulkReplaceCohorts","bulkReplaceCourses","editCoupon","selector","on","delete","initBulkActions"],"mappings":"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"}